# Описание скрипта резервного копирования

Этот Bash-скрипт предназначен для автоматизированного резервного копирования данных из Ceph FS на локальную файловую систему с использованием утилиты `rclone`. Он синхронизирует данные из указанных директорий, очищает устаревшие резервные копии, проверяет состояние Ceph-кластера и валидирует бэкапы. Скрипт включает механизмы обработки ошибок, повторных попыток, параллельного выполнения и подробного логирования. Ниже приведено описание его работы, разбитое на пункты.

## 1. Назначение скрипта
- **Основная цель**: Создание резервных копий данных из директорий `/ceph/data/exp/idream/data/` и `/ceph/data/exp/idream/data3/` на Ceph FS в локальные директории `/backup/main/ceph/data/exp/idream/data/` и `/backup/main/ceph/data/exp/idream/data3/`.
- **Функциональность**:
  - Синхронизация данных с помощью `rclone sync`.
  - Очистка данных старше 30 дней из директории `/backup/deleted`.
  - Проверка состояния Ceph-кластера и доступности исходных данных.
  - Частичная валидация бэкапов путём сравнения количества файлов.
  - Логирование всех операций и ошибок в файлы в `/var/log/backup`.
  - Параллельная обработка нескольких директорий (до 4 процессов).

## 2. Конфигурация скрипта
Скрипт использует следующие параметры, определённые в начале:
- **BACKUP_USER**: Имя пользователя для проверки прав доступа (`backup_user`).
- **LOGDIR**: Директория для логов (`/var/log/backup`).
- **LOCKFILE**: Файл блокировки для предотвращения одновременного запуска (`/var/lock/backup.lock`).
- **EXCLUDE_FILE**: Путь к файлу исключений для `rclone` (`/usr/local/bin/scripts/exclude-file.txt`).
- **DELETE_BACKUP**: Директория для перемещённых (удалённых) файлов (`/backup/deleted`).
- **MAIN_BACKUP**: Целевая директория для бэкапов (`/backup/main`).
- **SOURCEDIRS**: Массив исходных директорий (`/ceph/data/exp/idream/data/`, `/ceph/data/exp/idream/data3/`).
- **RCLONE_TRANSFERS**, **RCLONE_CHECKERS**, **RCLONE_RETRIES**: Параметры `rclone` для параллельных передач (30), проверок (8) и повторных попыток (5).

## 3. Инициализация и логирование
- **Создание лога**:
  - Для каждого запуска создаётся файл лога с временной меткой, например, `/var/log/backup/backup_2025-05-23_15-03.log`.
  - Директория логов создаётся, если не существует.
- **Ротация логов**:
  - Удаляются логи старше 30 дней.
  - Если в директории больше 100 логов, скрипт завершается с ошибкой.
- **Функция логирования**:
  - Функция `log` записывает сообщения с меткой времени и уровнем (INFO, WARNING, ERROR, DEBUG).
  - Сообщения выводятся в консоль и лог через `tee -a`.

## 4. Проверка конфигурации `rclone`
- **RCLONE_CONFIG**:
  - Проверяется наличие конфигурационного файла `rclone` с помощью `rclone config file`.
  - Если файл не найден, скрипт продолжает без `--config`, что подходит для локальных операций.
  - Если файл найден, его путь логируется и экспортируется.
- **Параметры `rclone`**:
  - Экспортируются `RCLONE_TRANSFERS`, `RCLONE_CHECKERS`, `RCLONE_RETRIES` для команд `rclone`.

## 5. Проверка файла исключений
- **EXCLUDE_FILE**:
  - Проверяется существование, читаемость и ненулевой размер файла `/usr/local/bin/scripts/exclude-file.txt`.
  - Содержимое файла логируется для отладки.
  - Если файл отсутствует, недоступен или пустой, скрипт завершается с ошибкой или выдаёт предупреждение.
- **Дополнительная проверка**:
  - В функции `backup_dir` повторно проверяется доступность и содержимое файла исключений для дочерних процессов.

## 6. Механизм блокировки
- **LOCKFILE**:
  - Используется `flock` для создания файла блокировки `/var/lock/backup.lock`.
  - Если скрипт уже запущен, он завершается с ошибкой.
- **Очистка**:
  - Файл блокировки удаляется при завершении скрипта (нормальном или по сигналу `INT`/`TERM`) через `trap`.

## 7. Проверка Ceph FS
- **Функция `check_ceph_access`**:
  - Проверяет наличие `/ceph` в `/etc/fstab`.
  - Убеждается, что `/ceph` смонтирован (`mountpoint -q`).
  - При необходимости предпринимает до 5 попыток монтирования с интервалом 30 секунд.
  - Проверяет доступность `/ceph` и исходных директорий с помощью `ls`.
  - Проверяет состояние Ceph-кластера через SSH на `cephsvc05` (`podman exec ceph-mon-cephsvc05 ceph status`). Если SSH недоступен, проверка пропускается с предупреждением.
- **Обработка ошибок**:
  - При любой неудачной проверке возвращается ненулевой код, и скрипт завершается.

## 8. Очистка устаревших данных
- **Функция `cleanup_old_backups`**:
  - Очищает данные старше 30 дней из `/backup/deleted` с помощью `rclone purge --min-age 30d`.
  - Проверяет доступность директории `/backup/deleted`.
  - Использует `retry_command` (3 попытки с задержкой 10 секунд).
- **Логирование**:
  - Успех или ошибки логируются.
  - При ошибке очистки скрипт продолжает работу с предупреждением.

## 9. Резервное копирование директорий
- **Функция `backup_dir`**:
  - Принимает путь к исходной директории (например, `/ceph/data/exp/idream/data/`).
  - Создаёт целевую директорию в `/backup/main/ceph/...`, сохраняя структуру Ceph FS.
  - Проверяет доступность исходной директории и файла исключений.
- **Команда `rclone sync`**:
  - Формируется через массив `RCLONE_FLAGS`:
    - `--progress`: Показ прогресса.
    - `--links`: Сохранение символических ссылок.
    - `--fast-list`: Оптимизация списков файлов.
    - `--create-empty-src-dirs`: Создание пустых директорий.
    - `--checksum`: Проверка по контрольным суммам.
    - `--transfers=30`, `--checkers=8`, `--retries=5`, `--retries-sleep=10s`: Параметры параллельности и повторных попыток.
    - `--update`: Копирование новых/изменённых файлов.
    - `--backup-dir=/backup/deleted/YYYY-MM-DD`: Перемещение удалённых файлов.
    - `--log-file`, `--log-level=INFO`: Логирование.
    - `--exclude-from=/usr/local/bin/scripts/exclude-file.txt`: Исключение файлов/директорий.
    - `--config` (при наличии `RCLONE_CONFIG`).
  - Выполняется с тремя попытками через `retry_command` (задержка 15 секунд).
- **Валидация**:
  - Функция `validate_backup` сравнивает количество файлов в исходной и целевой директориях (`rclone lsf --files-only`).
  - Успех или ошибка логируются.

## 10. Параллельная обработка
- **Функция `perform_backup`**:
  - Создаёт директории `/backup/main` и `/backup/deleted`.
  - Вызывает `check_ceph_access`, `cleanup_old_backups`.
  - Запускает `backup_dir` для каждой директории из `SOURCEDIRS` параллельно (до 4 процессов) через `xargs -P4`.
- **Экспорт**:
  - Экспортируются функции и переменные, включая `EXCLUDE_FILE`, для дочерних процессов `bash`.

## 11. Основной поток выполнения
- **Инициализация**:
  - Логируются пользователь, права на `/ceph` и `/backup`, версия `rclone`, конфигурация и параметры.
- **Выполнение**:
  - Вызывается `perform_backup`.
  - При успехе логируется завершение; при ошибке — завершение с кодом 1.

## 12. Обработка ошибок
- **Повторные попытки**:
  - `retry_command` выполняет команды `rclone` до трёх раз (задержка 10 секунд для `purge`, 15 секунд для `sync`).
- **Проверки**:
  - Проверяются права, существование файлов/директорий, состояние Ceph.
  - Критичные ошибки завершают скрипт; некритичные (например, проблемы с очисткой) логируются как WARNING.
- **Файл исключений**:
  - Проверяется на существование и читаемость, с повторной проверкой в `backup_dir`.

## 13. Логирование и отладка
- **Лог-файл**:
  - Записываются все операции, команды `rclone`, их попытки и результаты.
  - Уровни: INFO (события), WARNING (некритичные проблемы), ERROR (критичные ошибки), DEBUG (детали команд).
- **Отладка**:
  - Логируется содержимое файла исключений (в начале и в `backup_dir`).
  - Выводятся полные команды `rclone`.
  - Проверки прав и состояния системы документируются.

## 14. Зависимости
- **Утилиты**:
  - `rclone` (версия 1.62.2 или выше).
  - `bash`, `flock`, `find`, `xargs`, `tee`, `mountpoint`, `ls`, `cat`, `awk`.
  - `ssh` (опционально) для проверки Ceph.
- **Система**:
  - Доступ к Ceph FS через `/ceph`.
  - Права на чтение `/ceph` и запись в `/backup`.
  - Беспарольный SSH-доступ к `cephsvc05` (если используется).

## 15. Ограничения и особенности
- **Локальные операции**: Работает с локальными путями, так как `RCLONE_CONFIG` часто пустая. Для удалённых хранилищ нужна настройка `rclone`.
- **Параллелизм**: Ограничен 4 процессами, что подходит для двух директорий.
- **Файл исключений**: Требует корректных фильтров и доступности.
- **Валидация**: Проверяет только количество файлов.
- **SSH**: Проверка Ceph через SSH не критична и пропускается при отсутствии доступа.

## 16. Пример работы
1. Запуск скрипта как `root`.
2. Создаётся лог `/var/log/backup/backup_2025-05-23_15-03.log`.
3. Проверяются блокировка, Ceph FS, файл исключений.
4. Удаляются данные старше 30 дней из `/backup/deleted`.
5. Выполняется `rclone sync` для двух директорий в `/backup/main/ceph/...`, с учётом исключений.
6. Проверяется количество файлов.
7. Логируются результаты, и скрипт завершается.

## 17. Рекомендации по использованию
- **Проверка прав**: Убедитесь, что `root` имеет доступ к `/ceph`, `/backup` и `/usr/local/bin/scripts/exclude-file.txt`.
- **Файл исключений**: Регулярно проверяйте `/usr/local/bin/scripts/exclude-file.txt`.
- **Логи**: Анализируйте `/var/log/backup` для диагностики.
- **Тестирование**: Протестируйте на небольшом наборе данных.
- **SSH**: Настройте беспарольный SSH-доступ к `cephsvc05`.
- **Обновление `rclone`**: Рассмотрите последнюю версию для улучшения производительности.