Описание скрипта резервного копирования
Этот Bash-скрипт предназначен для автоматизированного резервного копирования данных из Ceph FS на локальную файловую систему с использованием утилиты rclone. Скрипт синхронизирует данные из указанных директорий, очищает устаревшие резервные копии, проверяет состояние Ceph-кластера и выполняет валидацию бэкапов. Он поддерживает параллельную обработку, подробное логирование и опциональное использование файла исключений. Ниже приведено описание его работы, разбитое на пункты.
1. Назначение скрипта

Основная цель: Создание резервных копий данных из директорий /ceph/data/exp/idream/data/ и /ceph/data/exp/idream/data3/ на Ceph FS в локальные директории /backup/main/ceph/data/exp/idream/data/ и /backup/main/ceph/data/exp/idream/data3/.
Функциональность:
Синхронизация данных с помощью rclone sync.
Очистка данных старше 30 дней из директории /backup/deleted.
Проверка состояния Ceph-кластера и доступности исходных данных.
Частичная валидация бэкапов путём сравнения количества файлов.
Логирование всех операций и ошибок в файлы в /var/log/backup.
Параллельная обработка директорий (до 4 процессов).
Опциональное использование файла исключений для фильтрации данных.



2. Конфигурация скрипта
Скрипт использует следующие параметры, определённые в начале:

BACKUP_USER: Имя пользователя для проверки прав доступа (backup_user).
LOGDIR: Директория для логов (/var/log/backup).
LOCKFILE: Файл блокировки для предотвращения одновременного запуска (/var/lock/backup.lock).
EXCLUDE_FILE: Путь к опциональному файлу исключений для rclone (/usr/local/bin/scripts/exclude-file.txt).
DELETE_BACKUP: Директория для перемещённых (удалённых) файлов (/backup/deleted).
MAIN_BACKUP: Целевая директория для бэкапов (/backup/main).
SOURCEDIRS: Массив исходных директорий (/ceph/data/exp/idream/data/, /ceph/data/exp/idream/data3/).
RCLONE_TRANSFERS, RCLONE_CHECKERS, RCLONE_RETRIES: Параметры rclone для параллельных передач (30), проверок (8) и повторных попыток (5).
USE_EXCLUDE_FILE: Булева переменная, указывающая, используется ли файл исключений (true или false).

3. Инициализация и логирование

Создание лога:
Для каждого запуска создаётся файл лога с временной меткой, например, /var/log/backup/backup_2025-05-23_15-24.log.
Директория логов (/var/log/backup) создаётся, если не существует.


Ротация логов:
Удаляются логи старше 30 дней.
Если в директории больше 100 логов, скрипт завершается с ошибкой.


Функция логирования:
Функция log записывает сообщения с меткой времени и уровнем (INFO, WARNING, ERROR, DEBUG).
Сообщения выводятся в консоль и лог через tee -a.



4. Проверка конфигурации rclone

RCLONE_CONFIG:
Проверяется наличие конфигурационного файла rclone с помощью rclone config file.
Если файл не найден, скрипт продолжает без параметра --config, что подходит для локальных операций.
Если файл найден, его путь логируется и экспортируется в переменную окружения.


Параметры rclone:
Экспортируются RCLONE_TRANSFERS, RCLONE_CHECKERS, RCLONE_RETRIES для использования в командах rclone.



5. Проверка файла исключений

EXCLUDE_FILE:
Проверяется существование файла /usr/local/bin/scripts/exclude-file.txt.
Если файл отсутствует, устанавливается USE_EXCLUDE_FILE=false, логируется предупреждение, и скрипт продолжает работу без --exclude-from.
Если файл существует, проверяются его читаемость и ненулевой размер:
При отсутствии прав на чтение скрипт завершается с ошибкой.
Если файл пустой, выдаётся предупреждение.


Содержимое файла логируется для отладки.


Повторная проверка:
В функции backup_dir повторно проверяется файл исключений, если USE_EXCLUDE_FILE=true, для обеспечения доступа в дочерних процессах.



6. Механизм блокировки

LOCKFILE:
Используется flock для создания файла блокировки /var/lock/backup.lock.
Если скрипт уже запущен, он завершается с ошибкой.


Очистка:
Файл блокировки удаляется при завершении скрипта (нормальном или по сигналу INT/TERM) через trap.



7. Проверка Ceph FS

Функция check_ceph_access:
Проверяет наличие /ceph в /etc/fstab.
Убеждается, что /ceph смонтирован с помощью mountpoint -q.
При необходимости предпринимает до 5 попыток монтирования с интервалом 30 секунд.
Проверяет доступность /ceph и исходных директорий (/ceph/data/exp/idream/data/, /ceph/data/exp/idream/data3/) с помощью ls.
Проверяет состояние Ceph-кластера через SSH на cephsvc05 с командой podman exec ceph-mon-cephsvc05 ceph status. Если SSH недоступен, проверка пропускается с предупреждением.


Обработка ошибок:
При любой неудачной проверке возвращается ненулевой код, и скрипт завершается.



8. Очистка устаревших данных

Функция cleanup_old_backups:
Очищает данные старше 30 дней из /backup/deleted с помощью rclone purge --min-age 30d.
Проверяет доступность директории /backup/deleted.
Использует механизм повторных попыток (3 попытки с задержкой 10 секунд) через функцию retry_command.


Логирование:
Успешное выполнение или ошибки логируются.
При ошибке очистки скрипт продолжает работу с предупреждением.



9. Резервное копирование директорий

Функция backup_dir:
Принимает путь к исходной директории (например, /ceph/data/exp/idream/data/).
Создаёт целевую директорию в /backup/main/ceph/..., сохраняя структуру Ceph FS.
Проверяет доступность исходной директории с помощью ls.
Если USE_EXCLUDE_FILE=true, проверяет доступность и содержимое файла исключений.


Команда rclone sync:
Формируется с использованием массива RCLONE_FLAGS, содержащего параметры:
--progress: Отображение прогресса.
--links: Сохранение символических ссылок.
--fast-list: Оптимизация списков файлов.
--create-empty-src-dirs: Создание пустых директорий.
--checksum: Проверка по контрольным суммам.
--transfers=30, --checkers=8, --retries=5, --retries-sleep=10s: Параметры параллельности и повторных попыток.
--update: Копирование только новых или изменённых файлов.
--backup-dir=/backup/deleted/YYYY-MM-DD: Перемещение удалённых файлов в директорию с текущей датой.
--log-file, --log-level=INFO: Логирование в файл.
--exclude-from=$EXCLUDE_FILE: Добавляется, только если USE_EXCLUDE_FILE=true.
--config (если RCLONE_CONFIG не пустая).


Команда выполняется с тремя попытками через retry_command с задержкой 15 секунд.


Валидация:
Функция validate_backup сравнивает количество файлов в исходной и целевой директориях с помощью rclone lsf --files-only.
Если количество совпадает, валидация считается успешной; иначе фиксируется ошибка.



10. Параллельная обработка

Функция perform_backup:
Создаёт директории /backup/main и /backup/deleted.
Вызывает check_ceph_access для проверки Ceph FS.
Вызывает cleanup_old_backups для очистки устаревших данных.
Обрабатывает директории из SOURCEDIRS параллельно (до 4 процессов) с помощью цикла for и фоновых процессов (backup_dir "$dir" &).
Использует wait -n для управления количеством одновременно выполняющихся задач.


Экспорт:
Экспортируются функции (log, retry_command, check_ceph_access, validate_backup, cleanup_old_backups, backup_dir) и переменные, включая USE_EXCLUDE_FILE, для использования в фоновых процессах.



11. Основной поток выполнения

Инициализация:
Логируются начальные данные: пользователь, права на /ceph и /backup, версия rclone, конфигурация и параметры.


Выполнение:
Вызывается perform_backup.
Если функция возвращает нулевой код возврата, логируется успешное завершение.
Если возвращён ненулевой код, логируется ошибка, и скрипт завершается с кодом 1.



12. Обработка ошибок

Повторные попытки:
Функция retry_command обеспечивает до трёх попыток выполнения команд rclone с задержкой (10 секунд для purge, 15 секунд для sync).


Проверки:
Проверяются права доступа, существование директорий, состояние Ceph-кластера.
Критичные ошибки (например, отсутствие /ceph в fstab или недоступность директорий) завершают скрипт.
Некритичные проблемы (например, отсутствие файла исключений или проблемы с очисткой) логируются как WARNING, и скрипт продолжает работу.


Файл исключений:
Отсутствие файла исключений обрабатывается как некритичное событие, и параметр --exclude-from не включается.



13. Логирование и отладка

Лог-файл:
Все операции, включая команды rclone, их попытки и результаты, записываются в лог.
Уровни лога: INFO (основные события), WARNING (некритичные проблемы), ERROR (критичные ошибки), DEBUG (детали команд).


Отладочная информация:
Логируется содержимое файла исключений (если он используется).
Выводятся полные команды rclone перед выполнением.
Проверки прав доступа, конфигурации и состояния системы подробно документируются.



14. Зависимости

Утилиты:
rclone (версия 1.62.2 или выше) для синхронизации и очистки.
bash, flock, find, tee, mountpoint, ls, cat, awk для работы скрипта.
ssh (опционально) для проверки состояния Ceph.


Система:
Доступ к Ceph FS через точку монтирования /ceph.
Права на чтение /ceph и запись в /backup.
Беспарольный SSH-доступ к cephsvc05 для проверки Ceph (если используется).



15. Ограничения и особенности

Локальные операции: Скрипт работает с локальными путями (/ceph и /backup), так как RCLONE_CONFIG часто пустая. Для удалённых хранилищ требуется настройка rclone.
Параллелизм: Ограничен 4 процессами, что подходит для двух директорий, но может быть увеличено при необходимости.
Файл исключений: Опционален; если отсутствует, бэкап выполняется без фильтрации.
Валидация: Проверяет только количество файлов, а не их содержимое.
SSH: Проверка Ceph через SSH не критична и пропускается при отсутствии доступа.

16. Пример работы

Скрипт запускается как root.
Создаётся лог /var/log/backup/backup_2025-05-23_15-24.log.
Проверяются ротация логов, конфигурация rclone, блокировка, Ceph FS, наличие файла исключений.
Если файл исключений отсутствует, логируется предупреждение, и бэкап продолжается без --exclude-from.
Удаляются данные старше 30 дней из /backup/deleted.
Выполняется rclone sync для /ceph/data/exp/idream/data/ и /ceph/data/exp/idream/data3/ в соответствующие директории /backup/main/ceph/....
Проверяется количество файлов в исходных и целевых директориях.
Логируются результаты, и скрипт завершается с соответствующим статусом.

17. Рекомендации по использованию

Проверка прав:
Убедитесь, что root имеет доступ к /ceph, /backup и (при необходимости) /usr/local/bin/scripts/exclude-file.txt.
Проверьте права скрипта:ls -l /usr/local/bin/scripts/rclone_03.sh
chmod 755 /usr/local/bin/scripts/rclone_03.sh




Файл исключений:
Если требуется фильтрация, создайте файл /usr/local/bin/scripts/exclude-file.txt с фильтрами rclone, например:echo -e "subdir1/**\nsubdir2/**" > /usr/local/bin/scripts/exclude-file.txt
chmod 644 /usr/local/bin/scripts/exclude-file.txt


Если фильтрация не нужна, файл можно не создавать.


Логи:
Анализируйте логи в /var/log/backup для диагностики проблем.
Проверяйте строки, связанные с USE_EXCLUDE_FILE, чтобы подтвердить, используется ли файл исключений.


Тестирование:
Протестируйте скрипт на небольшом наборе данных:/usr/local/bin/scripts/rclone_03.sh


Проверьте содержимое /backup/main/ceph/data/exp/idream/data/ и /backup/main/ceph/data/exp/idream/data3/.


SSH:
Настройте беспарольный SSH-доступ к cephsvc05 для проверки Ceph:ssh-copy-id cephsvc05
ssh cephsvc05 "podman exec ceph-mon-cephsvc05 ceph status"




Обновление rclone:
Рассмотрите обновление до последней версии rclone для улучшения производительности:rclone --version





